
<!DOCTYPE html>
<html lang="Zh-CN" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qemu_use-Log - 汐白的学习档案</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Xibai,"> 
    <meta name="description" content="这里是正在努力追赶大佬的小可爱QAQ嘤嘤嘤,~找到一个 09 年的工具仓库，建议本文直接废弃555~
qemuQEMU 是一个快捷的跨平台开源计算机模拟器，可以模拟许多硬件体系结构（在模拟固件设备时操作非常方便，一般IoT设备的虚拟机往往使用,"> 
    <meta name="author" content="Xibai"> 
    <link rel="alternative" href="atom.xml" title="汐白的学习档案" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    
    
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="Qemu_use-Log - 汐白的学习档案"/>
    <meta name="twitter:description" content="这里是正在努力追赶大佬的小可爱QAQ嘤嘤嘤,~找到一个 09 年的工具仓库，建议本文直接废弃555~
qemuQEMU 是一个快捷的跨平台开源计算机模拟器，可以模拟许多硬件体系结构（在模拟固件设备时操作非常方便，一般IoT设备的虚拟机往往使用,"/>
    
    
    
    
    <meta property="og:site_name" content="汐白的学习档案"/>
    <meta property="og:type" content="object"/>
    <meta property="og:title" content="Qemu_use-Log - 汐白的学习档案"/>
    <meta property="og:description" content="这里是正在努力追赶大佬的小可爱QAQ嘤嘤嘤,~找到一个 09 年的工具仓库，建议本文直接废弃555~
qemuQEMU 是一个快捷的跨平台开源计算机模拟器，可以模拟许多硬件体系结构（在模拟固件设备时操作非常方便，一般IoT设备的虚拟机往往使用,"/>
    
<link rel="stylesheet" href="/css/diaspora.css">

    <script>window.searchDbPath = "/search.xml";</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">汐白的学习档案</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="http://xibai.xyz"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">Qemu_use-Log</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">Qemu_use-Log</h1>
        <div class="stuff">
            <span>十二月 02, 2022</span>
            
    <!-- <div class=""> -->
      
        <!-- <time datetime="2022-12-02T07:05:45.000Z" itemprop="datePublished"></time> -->
        
        (Updated: <time datetime="2022-12-02T07:05:45.000Z" itemprop="dateModified">2022-12-02</time>)
        
      
    <!-- </div> -->


            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Env/" rel="tag">Env</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/IoT/" rel="tag">IoT</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Kernel/" rel="tag">Kernel</a></li></ul>


        </div>
        <div class="content markdown">
            <p><del>~找到一个 09 年的工具仓库，建议本文直接废弃555</del>~</p>
<h2 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu</h2><p>QEMU 是一个快捷的跨平台开源计算机模拟器，可以模拟许多硬件体系结构（<strong>在模拟固件设备时操作非常方便</strong>，一般<code>IoT</code>设备的虚拟机往往使用<code>qemu</code>来模拟）。QEMU 可让您在现有系统（VM 主机服务器）之上运行未经修改的完整操作系统 (VM Guest)。您还可以使用 QEMU 进行调试 — 可以轻松停止正在运行的虚拟机、检查其状态、保存并在以后恢复其状态。</p>
<p>QEMU 主要由以下部分构成：</p>
<ul>
<li>处理器模拟器。</li>
<li>模拟的设备，例如显卡、网卡、硬盘或鼠标。</li>
<li>用于将模拟的设备连接到相关主机设备的通用设备。</li>
<li>调试器。</li>
<li>用来与模拟器交互的用户界面。</li>
</ul>
<h2 id="linux-2-6-22kernel记录"><a href="#linux-2-6-22kernel记录" class="headerlink" title="linux-2.6.22kernel记录"></a>linux-2.6.22<em>kernel</em>记录</h2><ul>
<li>主机：win10 x64</li>
<li>VM：Ubuntu1604</li>
<li>目标内核版本：Linux-2.6.22</li>
</ul>
<h3 id="内核编译"><a href="#内核编译" class="headerlink" title="内核编译"></a>内核编译</h3><p>Ubuntu 安装 <code>make menuconfig</code> 指令的依赖：<code>apt-get install libncurses5-dev</code>。<br>CentOS 安装 <code>make menuconfig</code> 指令的依赖：<code>yum install ncurses ncurses-devel</code>。</p>
<h4 id="Makefile问题"><a href="#Makefile问题" class="headerlink" title="Makefile问题"></a>Makefile问题</h4><p>版本差距太大，<code>Makefile</code> 存在个别地方语法的不兼容，借此顺便看了下 <code>Makefile</code> 的相关语法学习。</p>
<p>先放总结：make其实可以当作一个特制的shell执行器。对于中型or大型 <code>c/c++</code> 项目而言，因为头文件、依赖文件、各模块源码文件过多，如果每次编译都去手敲一次命令，非常不便且容易出错。于是就制作了 <code>make</code> 工具。</p>
<p>make工具的主要功能，将数量庞大的 <code>gcc编译命令</code> 格式化脚本化。格式化也就是相当于写个通项，然后根据这个通项自动生成每一条编译命令继而执行。模块化是对于不同的编译场景用户会有不同的编译需求，通过配置文件来将这些需求分化为不同的配置模块、命令模块、使其操作变得傻瓜化。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">A: B</span></span><br><span class="line">    shell code（C）</span><br></pre></td></tr></table></figure>
<p>A 代表所要编译生成的目标、B代表该目标的依赖文件（头文件、源码文件等等凡是用到的都可以是）、C代表具体的编译命令（也可以是一些 shell 中执行的命令）<br>当B集合中的文件时间戳发生变化，则make会对目标文件进行重新编译；否则make会跳过该目标的编译直接执行下一个目标的编译。</p>
<p>在<code>Makefile</code>中支持shell的一些基础语法，且make内置了一些功能函数。这里不多赘述</p>
<p>参考链接：</p>
<pre><code>- &lt;https://blog.51cto.com/u_15127598/4090088&gt;
- &lt;https://zhuanlan.zhihu.com/p/442028798&gt;
</code></pre><p>需要解决的地方：</p>
<p><img src="./makefile-1.png" alt="makefile-1"></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 415 行，对应报错信息</span></span><br><span class="line">config %config: scripts_basic outputmakefile FORCE</span><br><span class="line">        <span class="variable">$(Q)</span>mkdir -p <span class="keyword">include</span>/linux <span class="keyword">include</span>/config</span><br><span class="line">        <span class="variable">$(Q)</span><span class="variable">$(MAKE)</span> <span class="variable">$(build)</span>=scripts/kconfig <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1443 行，对应报错信息</span></span><br><span class="line">/ %/: prepare scripts FORCE</span><br><span class="line">        <span class="variable">$(cmd_crmodverdir)</span></span><br><span class="line">        <span class="variable">$(Q)</span><span class="variable">$(MAKE)</span> KBUILD_MODULES=<span class="variable">$(<span class="built_in">if</span> <span class="variable">$(CONFIG_MODULES)</span>,1)</span> \</span><br><span class="line">        <span class="variable">$(build)</span>=$(build-dir)</span><br></pre></td></tr></table></figure>
<p>这里删除第一个 <code>config</code> 和 <code>/</code> ，如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 415</span></span><br><span class="line"><span class="section">%config: scripts_basic outputmakefile FORCE</span></span><br><span class="line">        <span class="variable">$(Q)</span>mkdir -p <span class="keyword">include</span>/linux <span class="keyword">include</span>/config</span><br><span class="line">        <span class="variable">$(Q)</span><span class="variable">$(MAKE)</span> <span class="variable">$(build)</span>=scripts/kconfig <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1443</span></span><br><span class="line"><span class="section">%/: prepare scripts FORCE</span></span><br><span class="line">        <span class="variable">$(cmd_crmodverdir)</span></span><br><span class="line">        <span class="variable">$(Q)</span><span class="variable">$(MAKE)</span> KBUILD_MODULES=<span class="variable">$(<span class="built_in">if</span> <span class="variable">$(CONFIG_MODULES)</span>,1)</span> \</span><br><span class="line">        <span class="variable">$(build)</span>=$(build-dir)</span><br></pre></td></tr></table></figure>
<h4 id="内核配置问题"><a href="#内核配置问题" class="headerlink" title="内核配置问题"></a>内核配置问题</h4><p>如果是2.6.26版本的内核，会遭遇报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~/linux-2.6.26$ make -j4 | grep error</span><br><span class="line">Can<span class="string">&#x27;t use &#x27;</span>defined(@array)<span class="string">&#x27; (Maybe you should just omit the defined()?) at kernel/timeconst.pl line 373.</span></span><br><span class="line"><span class="string">make[1]: *** [kernel/timeconst.h] Error 255</span></span><br><span class="line"><span class="string">make: *** [kernel] Error 2</span></span><br><span class="line"><span class="string">make: *** Waiting for unfinished jobs....</span></span><br><span class="line"><span class="string">gcc: error: unrecognized command line option ‘-m’</span></span><br><span class="line"><span class="string">gcc: error: elf_x86_64: No such file or directory</span></span><br><span class="line"><span class="string">make[1]: *** [arch/x86/vdso/vdso.so.dbg] Error 1</span></span><br><span class="line"><span class="string">make: *** [arch/x86/vdso] Error 2</span></span><br></pre></td></tr></table></figure>
<p>修改 <code>arch/x86/vdso/Makefile</code> 中 <code>-m elf_x86_64</code> 为 <code>-m64</code> <code>-m elf_i386</code> <code>-m32</code>。<br>继续编译：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error: .size expression <span class="keyword">for</span> copy_user_generic_c does not evaluate to a constant</span><br><span class="line">scripts/Makefile.build:238: recipe <span class="keyword">for</span> target <span class="string">&#x27;arch/x86_64/lib/copy_user.o&#x27;</span> failed</span><br></pre></td></tr></table></figure>
<p>去对应的源码文件查看错误出处</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">ENTRY</span>(copy_user_generic_string)</span><br><span class="line">        CFI_STARTPROC</span><br><span class="line">        movl %ecx,%r8d          <span class="comment">/* save zero flag */</span></span><br><span class="line">        movl %edx,%ecx</span><br><span class="line">        shrl <span class="number">$3</span>,%ecx</span><br><span class="line">        andl <span class="number">$7</span>,%edx</span><br><span class="line">        jz   <span class="number">10</span>f</span><br><span class="line"><span class="number">1</span>:      rep</span><br><span class="line">        movsq</span><br><span class="line">        movl %edx,%ecx</span><br><span class="line"><span class="number">2</span>:      rep</span><br><span class="line">        movsb</span><br><span class="line"><span class="number">9</span>:      movl %ecx,%eax</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* multiple of 8 byte */</span></span><br><span class="line"><span class="number">10</span>:     rep</span><br><span class="line">        movsq</span><br><span class="line">        xor %eax,%eax</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* exception handling */</span></span><br><span class="line"><span class="number">3</span>:      lea (%rdx,%rcx,<span class="number">8</span>),%rax  <span class="comment">/* exception on quad loop */</span></span><br><span class="line">        jmp <span class="number">6</span>f</span><br><span class="line"><span class="number">5</span>:      movl %ecx,%eax          <span class="comment">/* exception on byte loop */</span></span><br><span class="line">        <span class="comment">/* eax: left over bytes */</span></span><br><span class="line"><span class="number">6</span>:      testl %r8d,%r8d         <span class="comment">/* zero flag set? */</span></span><br><span class="line">        jz <span class="number">7</span>f</span><br><span class="line">        movl %eax,%ecx          <span class="comment">/* initialize x86 loop counter */</span></span><br><span class="line">        <span class="keyword">push</span> %rax</span><br><span class="line">        xorl %eax,%eax</span><br><span class="line"><span class="number">8</span>:      rep</span><br><span class="line">        stosb                   <span class="comment">/* zero the rest */</span></span><br><span class="line"><span class="number">11</span>:     <span class="keyword">pop</span> %rax</span><br><span class="line"><span class="number">7</span>:      ret</span><br><span class="line">        CFI_ENDPROC</span><br><span class="line"><span class="symbol">END</span>(copy_user_generic_c)</span><br></pre></td></tr></table></figure>
<p>可以发现是头尾名字不对应，<code>copy_user_generic_c</code> 改为 <code>copy_user_generic_string</code>。</p>
<hr>
<p>往后是通用报错</p>
<p>而后再次编译得到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kernel/built-in.o: In <span class="keyword">function</span> <span class="string">&#x27;mutex_lock&#x27;</span>:</span><br><span class="line">linux-2.6.22/kernel/mutex.c:91: undefined reference to <span class="string">&#x27;__mutex_lock_slowpath&#x27;</span></span><br><span class="line">kernel/built-in.o: In <span class="keyword">function</span> <span class="string">&#x27;mutex_unlock&#x27;</span>:</span><br><span class="line">linux-2.6.22/kernel/mutex.c:116: undefined reference to <span class="string">&#x27;__mutex_unlock_slowpath&#x27;</span></span><br></pre></td></tr></table></figure>
<p>跟踪源码发现，<code>CONFIG_DEBUG_MUTEXES</code> 影响了头文件的包含，与其有关：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_MUTEXES</span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&quot;mutex-debug.h&quot;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;asm-generic/mutex-null.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&quot;mutex.h&quot;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;asm/mutex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>grep -r</code> 搜索其出现的位置，找到如何影响的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -r CONFIG_DEBUG_MUTEXES .</span><br><span class="line">./.config:<span class="comment"># CONFIG_DEBUG_MUTEXES is not set</span></span><br></pre></td></tr></table></figure>
<p>在配置文件中设置为 y 。继续编译:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">arch</span>/x86_64/boot/compressed/misc.o: In <span class="keyword">function</span> <span class="string">&#x27;inflate_fixed&#x27;</span>:</span><br><span class="line">misc.c:(.text+0xf5a): undefined reference to <span class="string">&#x27;__stack_chk_fail&#x27;</span></span><br><span class="line"><span class="built_in">arch</span>/x86_64/boot/compressed/misc.o: In <span class="keyword">function</span> <span class="string">&#x27;inflate_dynamic&#x27;</span>:</span><br><span class="line">misc.c:(.text+0x14fa): undefined reference to <span class="string">&#x27;__stack_chk_fail&#x27;</span></span><br></pre></td></tr></table></figure>
<p>该报错是因为默认开启了栈保护策略，在 <code>Makefile</code> 中找到内核模块的编译参数，添加 <code>--fno-stack-protector</code></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CHECKFLAGS     := -D__linux__ -Dlinux -D__STDC__ -Dunix -D__unix__ -Wbitwise <span class="variable">$(CF)</span></span><br><span class="line">MODFLAGS        = -DMODULE</span><br><span class="line">CFLAGS_MODULE   = <span class="variable">$(MODFLAGS)</span></span><br><span class="line">AFLAGS_MODULE   = <span class="variable">$(MODFLAGS)</span></span><br><span class="line">LDFLAGS_MODULE  = -r</span><br><span class="line">CFLAGS_KERNEL   = -fno-stack-protector</span><br><span class="line">AFLAGS_KERNEL   =</span><br></pre></td></tr></table></figure>
<p>出现以下内容说明内核编译完成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Root device is (8, 1) <span class="comment"># </span></span><br><span class="line">Boot sector 512 bytes.</span><br><span class="line">Setup is 7377 bytes.</span><br><span class="line">System is 2281 kB</span><br><span class="line">Kernel: <span class="built_in">arch</span>/x86_64/boot/bzImage is ready  (<span class="comment">#2)</span></span><br><span class="line">  MODPOST 1099 modules</span><br></pre></td></tr></table></figure>
<h3 id="qemu-运行"><a href="#qemu-运行" class="headerlink" title="qemu 运行"></a>qemu 运行</h3><p>为其制作基础文件系统。</p>
<p>先准备一个 <code>init</code> 程序。比如：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Hello\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后制作虚拟介质并挂载。用 VM 类比就是 虚拟硬盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=myinitrd.img bs=4M count=1</span><br><span class="line">mkfs.ext3 myinitrd.img</span><br><span class="line"><span class="built_in">mkdir</span> rootfs</span><br><span class="line">sudo mount -o loop myinitrd.img rootfs</span><br></pre></td></tr></table></figure>
<p>这里刚制作的虚拟介质是空白的，需要填充文件系统的必要内容。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> init rootfs/</span><br><span class="line"><span class="built_in">cd</span> rootfs</span><br><span class="line">sudo <span class="built_in">mkdir</span> dev</span><br><span class="line">sudo <span class="built_in">mknod</span> dev/ram b 1 0</span><br><span class="line">sudo <span class="built_in">mknod</span> dev/console c 5 1</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">sudo umount rootfs</span><br></pre></td></tr></table></figure>
<p><code>mknod</code> 用于创建设备文件。</p>
<ul>
<li>参数为 <code>b</code> 时面向设备驱动，Linux下万物皆文件，通过该文件访问硬件驱动从而使用该硬件。</li>
<li>参数为 <code>c</code> 是面向字符。比如与打印机、控制台进行数据交互。</li>
<li>两个数字参数分别是主从设备号。在 Linux 下，设备集通过主设备号分类，每一个主设备号对应一大类设备的驱动，比如 <code>b 1</code> 就代表<code>ramdisk</code> 类型的设备；从设备号代表该类型设备集中具体的某个设备的序号。</li>
</ul>
<p>通过对应架构的qemu运行内核及刚制作的简易文件系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -kernel path/bzImage -initrd path/myinitrd.img -m 512M --append <span class="string">&quot;root=/dev/ram init=/init&quot;</span></span><br></pre></td></tr></table></figure>
<p><code>bzImage</code> 是linux的内核镜像文件。是make编译时自动生成好的。内核文件的编译会有三个阶段，第一阶段是“裸内核”静态elf文件的编译生成；第二阶段会将其和 boot 程序 压缩成一个二进制文件 <code>vmlinux.bin</code>；第三阶段 会生成 <code>bzImage</code> 或者说 <code>vmlinuz</code>，可引导的压缩linux内核。通过 gzip 进行压缩。</p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/466591309">https://zhuanlan.zhihu.com/p/466591309</a></li>
<li><a target="_blank" rel="noopener" href="https://www.shuzhiduo.com/A/RnJWm6GEdq/">https://www.shuzhiduo.com/A/RnJWm6GEdq/</a></li>
<li><a target="_blank" rel="noopener" href="http://t.zoukankan.com/ldxsuanfa-p-9952120.html">http://t.zoukankan.com/ldxsuanfa-p-9952120.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/baidu_31504167/article/details/93606946">https://blog.csdn.net/baidu_31504167/article/details/93606946</a></li>
</ul>
<p>qemu启动过程中报错：提示挂载文件系统过程中不能识别到 <code>gzip header</code>，即 <code>myinitrd.img</code> 应该使用 gzip 压缩算法，这里先 直接 gzip 将其压缩一下康康什么效果。<br>发现这次提示找不 <code>cpio magic header</code>。查阅资料得知，linux2.6 内核支持两种格式的 initrd（虚拟文件系统），一种是 linux2.4 内核那种传统格式的文件系统镜像 <code>image-initrd</code>，其核心文件就是 <code>/linuxrc</code>；另外一种格式的 <code>initrd</code> 是 <code>cpio</code> 格式的，这种格式的 <code>initrd</code> 使用 <code>cpio</code> 工具生成，其核心文件不再是 <code>/linuxrc</code>，而是 <code>/init</code>。也就是说我们这里使用系统工具生产的虚拟介质其数据格式存在问题。我们手动压缩一个可用文件出来启动一下试试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo find path/rootfs -depth -<span class="built_in">print</span> | cpio -o -Hnewc | gzip -9 &gt; myinitrd.cpio.gz</span><br><span class="line">qemu-system-x86_64 -kernel path/bzImage -initrd path/myinitrd.img -m 512M --append <span class="string">&quot;root=/dev/ram init=/init&quot;</span></span><br></pre></td></tr></table></figure>
<p>挂载成功，但是提示 不能打开 <code>root 设备 ram（1，0）</code>。此时通过 <code>file</code> 命名查看前后两个文件系统文件的属性发现，第一次生成的文件属于硬盘，但第二次就只能算是个压缩归档文件了。推测应该是主设备号对应的驱动不对所以无法正常启动。这里我们可以通过修改 <code>内核配置</code> 的讲文件系统直接编译进内核镜像，让其编译时自动识别并包含。</p>
<p>到源码根路径 <code>make menuconfig</code>，修改 <code>General setup</code> 中选项，如下图：</p>
<p><img src="./makefile-2.png" alt="makefile-2"></p>
<p>编译过程中根据编译日志确认是因为主设备号错误导致无法正常启动，压缩文件类的文件系统主设备号使用 8 。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  Building modules, stage 2.</span><br><span class="line">  OBJCOPY <span class="built_in">arch</span>/x86_64/boot/compressed/vmlinux.bin</span><br><span class="line">  GZIP    <span class="built_in">arch</span>/x86_64/boot/compressed/vmlinux.bin.gz</span><br><span class="line">  MODPOST 1099 modules</span><br><span class="line">  LD      <span class="built_in">arch</span>/x86_64/boot/compressed/piggy.o</span><br><span class="line">  LD      <span class="built_in">arch</span>/x86_64/boot/compressed/vmlinux</span><br><span class="line">  OBJCOPY <span class="built_in">arch</span>/x86_64/boot/vmlinux.bin</span><br><span class="line">  BUILD   <span class="built_in">arch</span>/x86_64/boot/bzImage</span><br><span class="line">Root device is (8, 1)</span><br><span class="line">Boot sector 512 bytes.</span><br><span class="line">Setup is 7382 bytes.</span><br><span class="line">System is 2643 kB</span><br><span class="line">Kernel: <span class="built_in">arch</span>/x86_64/boot/bzImage is ready  (<span class="comment">#6)</span></span><br></pre></td></tr></table></figure>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/kunkliu/article/details/104838764">https://blog.csdn.net/kunkliu/article/details/104838764</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Andy-Lv/p/5304247.html">https://www.cnblogs.com/Andy-Lv/p/5304247.html</a></li>
</ul>
<p>再次运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -kernel path/bzImage -m 512M --append <span class="string">&quot;root=/dev/ram init=/init&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="./qemu-1.png" alt="qemu-1"></p>
<p>可以看到系统已经运转起来了，但是因为本地内核版本、gcc版本均高于目标，导致本地编译的程序运行时出现段错误异常。除此之外，在真机路由器上面使用较低版本gcc编译的静态程序时也会自检提示 内核版本太老无法运行。</p>
<p>一番苦苦挣扎，成功找到一个 09 年的仓库，存放了当年编译好的 各种架构的 gcc。下载尝试,终于成功运行起来</p>
<p>仓库地址：<a target="_blank" rel="noopener" href="https://www.uclibc.org/downloads/binaries/0.9.30.1/">https://www.uclibc.org/downloads/binaries/0.9.30.1/</a></p>
<p><img src="./qemu-2.jpg" alt="qemu-2"></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                </ul>
            
        </div>
        
        
    <div id="gitalk-container" class="comment link"
		data-enable="true"
        data-ae="true"
        data-ci="5cd24ed310c0cbc2a2ed"
        data-cs="51aa998e509794b7b061784f1f3d41018af118f6"
        data-r="xikong-mubai.github.io"
        data-o="xikong-mubai"
        data-a="xikong-mubai"
        data-d="false"
    >查看评论</div>


    </div>
    
        <div class="side">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#qemu"><span class="toc-number">1.</span> <span class="toc-text">qemu</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux-2-6-22kernel%E8%AE%B0%E5%BD%95"><span class="toc-number">2.</span> <span class="toc-text">linux-2.6.22kernel记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91"><span class="toc-number">2.1.</span> <span class="toc-text">内核编译</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Makefile%E9%97%AE%E9%A2%98"><span class="toc-number">2.1.1.</span> <span class="toc-text">Makefile问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98"><span class="toc-number">2.1.2.</span> <span class="toc-text">内核配置问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#qemu-%E8%BF%90%E8%A1%8C"><span class="toc-number">2.2.</span> <span class="toc-text">qemu 运行</span></a></li></ol></li></ol>
        </div>
    
</div>


    </div>
</div>
</body>

<!--血小板代码-->
<link rel="stylesheet" href="/live2d/css/live2d.css" />
<div id="landlord">
    <div class="message" style="opacity:0"></div>
    <canvas id="live2d" width="280" height="250" class="live2d"></canvas>
    <div class="hide-button">隐藏</div>
</div>
<script type="text/javascript" src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript">
    var message_Path = '/live2d/'
    var home_Path = 'https://calmcenter.club/'
</script>
<script type="text/javascript" src="/live2d/js/live2d.js"></script>
<script type="text/javascript" src="/live2d/js/message.js"></script>
<script type="text/javascript">
    loadlive2d("live2d", "/live2d/model/kesshouban_v2/model.json");
</script>
<!--血小板代码-->


<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



<script type="text/x-mathjax-config">
    MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
        tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
        TeX: {  noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
        messageStyle: "none"
    });
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>




</html>
